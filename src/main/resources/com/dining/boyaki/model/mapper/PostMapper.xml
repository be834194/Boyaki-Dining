<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dining.boyaki.model.mapper.PostMapper">
    <select id = "findNickName" resultType="String">
        SELECT
            NICKNAME
        FROM
            ACCOUNT_INFO
        WHERE
            USERNAME = #{userName}
    </select>
    
    <select id = "findProfile" parameterType="String"
                               resultType="com.dining.boyaki.model.entity.AccountInfo">
        SELECT
            NICKNAME,PROFILE,STATUS,GENDER,AGE
        FROM
            ACCOUNT_INFO
        WHERE
            NICKNAME = #{nickName}
    </select>
    
    <insert id = "insertPost" parameterType="com.dining.boyaki.model.entity.Post">
        INSERT INTO
            POST(USERNAME,NICKNAME,CONTENT,POSTCATEGORY,CREATEAT)
        VALUES(
               #{userName},
               #{nickName},
               #{content},
               #{postCategory},
               #{createAt}
               )
    </insert>

    <select id = "searchPostRecord" resultMap="PostRecordResultMap">
        SELECT
            POST.NICKNAME,
            S_LIST.STATUSNAME,
            P_CATEGORY.POSTNAME,
            POST.CONTENT,
            CAST(POST.CREATEAT as CHAR) as CREATEAT
        FROM
            POST as POST
        INNER JOIN ACCOUNT_INFO as INFO
              ON   POST.NICKNAME = INFO.NICKNAME
        INNER JOIN STATUS_LIST as S_LIST
              ON   INFO.STATUS = S_LIST.STATUSID
        INNER JOIN POST_CATEGORY as P_CATEGORY
              ON  POST.POSTCATEGORY = P_CATEGORY.POSTID
        <where>
            <if test="category != null">
                <foreach item="categoryId" index="i" collection="category"
                         open="POST.POSTCATEGORY IN (" separator="," close=")">
                         #{categoryId}
                </foreach>
            </if>
            <if test="status!= null">
                AND <foreach item="statusId" index="j" collection="status"
                         open="INFO.STATUS IN (" separator="," close=")">
                         #{statusId}
                </foreach>
            </if>
            <if test="content!= null">
                AND <foreach item="text" index="k" collection="content"
                         open="(" separator=" and " close=")">
                         POST.CONTENT LIKE '%${text}%'
                </foreach>
            </if>
        </where>
        ORDER BY POST.CREATEAT DESC
        LIMIT #{pageable.pageSize}
        OFFSET #{pageable.offset}
    </select>
    
    <resultMap id="PostRecordResultMap" type="com.dining.boyaki.model.entity.PostRecord">
      <result property="nickName" column="nickname"></result>
      <result property="status" column="statusname"></result>
      <result property="postCategory" column="postname"></result>
      <result property="content" column="content"></result>
      <result property="createAt" column="createAt"></result>
    </resultMap>
    
</mapper>
